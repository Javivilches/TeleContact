<!-- TeleContact AI Chat (widget) -->
<div id="tc-chat" class="tc-chat">
  <div class="tc-chat-header">
    <span>TeleContact ¬∑ Soporte</span>
    <button id="tc-chat-min" type="button" aria-label="Minimizar">‚Äì</button>
  </div>

  <div id="tc-chat-log" class="tc-chat-log">
    <div class="tc-msg tc-bot">Hola üëã ¬øEn qu√© te ayudo?</div>
  </div>

  <form id="tc-chat-form" class="tc-chat-form">
    <input id="tc-chat-input" type="text" placeholder="Escribe tu mensaje‚Ä¶" autocomplete="off" />
    <button id="tc-chat-send" type="submit">Enviar</button>
  </form>
</div>

<button id="tc-chat-fab" class="tc-chat-fab" type="button" aria-label="Abrir chat">
  üí¨
</button>

<style>
  .tc-chat-fab{
    position:fixed; right:18px; bottom:18px; z-index:9999;
    width:54px; height:54px; border-radius:999px; border:none;
    background:#0B4FA9; color:#fff; font-size:22px; cursor:pointer;
    box-shadow:0 10px 25px rgba(0,0,0,.18);
  }
  .tc-chat{
    position:fixed; right:18px; bottom:84px; z-index:9999;
    width:340px; max-width: calc(100vw - 36px);
    background:#fff; border:1px solid rgba(0,0,0,.08);
    border-radius:14px; overflow:hidden;
    box-shadow:0 18px 50px rgba(0,0,0,.16);
    display:none;
  }
  .tc-chat.open{ display:block; }
  .tc-chat-header{
    background:#001F4D; color:#fff;
    padding:10px 12px; display:flex; align-items:center; justify-content:space-between;
    font-size:13px; font-weight:600;
  }
  .tc-chat-header button{
    border:none; background:transparent; color:#fff; font-size:18px; cursor:pointer;
    line-height:1;
  }
  .tc-chat-log{
    padding:12px; height:280px; overflow:auto; background:#fff;
  }
  .tc-msg{
    max-width: 85%;
    padding:9px 10px; border-radius:12px; margin:8px 0; font-size:13px;
    border:1px solid rgba(0,0,0,.06);
  }
  .tc-bot{ background:#F7F7FB; }
  .tc-me{ background:#0B4FA9; color:#fff; margin-left:auto; border-color:transparent; }
  .tc-chat-form{
    display:flex; gap:8px; padding:10px; border-top:1px solid rgba(0,0,0,.06);
    background:#fff;
  }
  .tc-chat-form input{
    flex:1; padding:10px 10px; border-radius:999px;
    border:1px solid rgba(0,0,0,.16); outline:none; font-size:13px;
  }
  .tc-chat-form button{
    padding:10px 14px; border-radius:999px; border:1px solid #0B4FA9;
    background:#0B4FA9; color:#fff; cursor:pointer; font-weight:600; font-size:13px;
  }
</style>

<script>
  // 1) PON AQU√ç la URL de tu Worker (la creamos en el paso 2)
  const TC_CHAT_ENDPOINT = "https://TU-WORKER.tudominio.workers.dev/api/chat";

  const fab = document.getElementById("tc-chat-fab");
  const box = document.getElementById("tc-chat");
  const min = document.getElementById("tc-chat-min");
  const log = document.getElementById("tc-chat-log");
  const form = document.getElementById("tc-chat-form");
  const input = document.getElementById("tc-chat-input");
  const sendBtn = document.getElementById("tc-chat-send");

  const messages = []; // historial (user/assistant)

  function addMsg(text, who){
    const d = document.createElement("div");
    d.className = "tc-msg " + (who === "me" ? "tc-me" : "tc-bot");
    d.textContent = text;
    log.appendChild(d);
    log.scrollTop = log.scrollHeight;
  }

  fab.addEventListener("click", () => {
    box.classList.toggle("open");
    if (box.classList.contains("open")) input.focus();
  });

  min.addEventListener("click", () => box.classList.remove("open"));

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = (input.value || "").trim();
    if (!text) return;

    addMsg(text, "me");
    messages.push({ role: "user", content: text });
    input.value = "";
    sendBtn.disabled = true;

    // ‚Äútyping‚Ä¶‚Äù
    const typing = document.createElement("div");
    typing.className = "tc-msg tc-bot";
    typing.textContent = "Escribiendo‚Ä¶";
    log.appendChild(typing);
    log.scrollTop = log.scrollHeight;

    try{
      const r = await fetch(TC_CHAT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages })
      });

      if (!r.ok) throw new Error("HTTP " + r.status);
      const data = await r.json();

      typing.remove();
      addMsg(data.reply || "Ahora mismo no puedo responder. Prueba en un minuto.", "bot");
      messages.push({ role: "assistant", content: data.reply || "" });
    }catch(err){
      typing.remove();
      addMsg("Ahora mismo no puedo responder. Prueba m√°s tarde o escr√≠benos por WhatsApp.", "bot");
    }finally{
      sendBtn.disabled = false;
      input.focus();
    }
  });
</script>
